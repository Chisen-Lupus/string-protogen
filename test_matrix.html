<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Protogen Half-Face Expression Matrix</title>
    <link rel="stylesheet" href="errorLogger.css" />
    <style>
      body {
        margin: 0;
        background-color: black;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        height: 100vh;
      }
      canvas {
        position: relative;
        width: 100vw;
        height: 62.5vw;
        border: 1px solid gray;
      }
    </style>
  </head>
  <body>
    <canvas id="matrixCanvas" width="1920" height="1200"></canvas>
    <div id="errorLog">No errors yet.</div>
    <script type="module">
      import { setupErrorLogger } from "./errorLogger.js";
      setupErrorLogger();

      nonexistentFunction();

      const canvas = document.getElementById("matrixCanvas");
      const ctx = canvas.getContext("2d");
      const errorLog = document.getElementById("errorLog");
      const cellSize = 60;
      const circleRadius = 20;
      const matrixSize = 8;

      // Define matrix data
      const A1 = [
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
      ];
      const B1 = [
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
        [0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff],
      ];

      const A2 = [
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
      ];
      const B2 = [
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
      ];

      let progress = 0;
      let animating = true;
      let stableTime = 0;
      let toggle = true;

      function interpolate(a, b, t) {
        return a * (1 - t) + b * t;
      }

      function drawMatrix(matrix1, matrix2, offsetX, offsetY) {
        for (let i = 0; i < matrixSize; i++) {
          for (let j = 0; j < matrixSize; j++) {
            const isOpaque1 = (matrix1[i] & (1 << (7 - j))) !== 0;
            const isOpaque2 = (matrix2[i] & (1 << (7 - j))) !== 0;
            const opacity = interpolate(
              isOpaque1 ? 1 : 0,
              isOpaque2 ? 1 : 0,
              progress
            );
            const x = offsetX + j * cellSize;
            const y = offsetY + i * cellSize;
            ctx.beginPath();
            ctx.arc(x, y, circleRadius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 0, 0, ${opacity})`;
            ctx.fill();
          }
        }
      }

      function drawAll() {
        try {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const currentA = toggle ? A1 : A2;
          const currentB = toggle ? B1 : B2;
          const nextA = toggle ? A2 : A1;
          const nextB = toggle ? B2 : B1;

          drawMatrix(currentA, nextA, 900 + 480, 50);
          drawMatrix(currentA, nextA, 900, 50);
          drawMatrix(currentB, nextB, 100 + 3 * 480, 700);
          drawMatrix(currentB, nextB, 100 + 2 * 480, 700);
          drawMatrix(currentB, nextB, 100 + 480, 700);
          drawMatrix(currentB, nextB, 100, 700);
        } catch (err) {
          logError(`Draw error: ${err.message}`);
        }
      }

      function animate() {
        if (animating) {
          progress += 0.02;
          if (progress >= 1) {
            progress = 0;
            animating = false;
            stableTime = 0;
            toggle = !toggle;
          }
        } else {
          stableTime += 1 / 60;
          if (stableTime >= 2) {
            animating = true;
          }
        }
        drawAll();
        requestAnimationFrame(animate);
      }

      animate();
    </script>
  </body>
</html>
